<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Security Awareness XR Experience</title>
    
    <!-- External CSS -->
    <link rel="stylesheet" href="./css/main.css">
    <link rel="stylesheet" href="./css/app.css">
    
    <!-- Three.js and WebXR Scripts - Load in correct order -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/examples/js/controls/OrbitControls.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/examples/js/loaders/GLTFLoader.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/examples/js/webxr/VRButton.js"></script>
</head>
<body>
    <div id="container">
        <div id="ui">
            <h1>🛡️ Security Awareness XR</h1>
            <div id="status">Initializing...</div>
            <div id="gestureStatus">Gesture detection: Loading...</div>
        </div>
        
        <div id="controls">
            <button id="enterVRBtn" class="btn" style="display: none;">Enter VR</button>
            <button id="resetBtn" class="btn">Reset Experience</button>
        </div>
        
        <div id="subtitle"></div>
        
        <div class="gesture-indicator" id="gestureIndicator">
            👋 Wave detected!
        </div>
        
        <div class="loading-indicator" id="loadingIndicator">
            <div class="spinner"></div>
            <div>Loading Security XR Experience...</div>
        </div>
    </div>

    <!-- Load your custom modules as regular scripts (not ES6 modules) -->
    <script src="./js/utils.js"></script>
    <script src="./js/gestures.js"></script>
    <script src="./js/characters.js"></script>
    <script src="./js/story.js"></script>

    <script>
    // Application state
    let app = {
      scene: null,
      camera: null,
      renderer: null,
      characters: {},
      audio: {},
      gestureDetector: null,
      storyController: null,
      webxrManager: null,
      currentState: 'waiting',
      clock: new THREE.Clock(),
      isInitialized: false
    };

    // Create Three.js scene
    function createScene() {
      // Scene setup
      app.scene = new THREE.Scene();
      app.scene.background = new THREE.Color(0x002244);

      // Camera setup
      app.camera = new THREE.PerspectiveCamera(
        75, 
        window.innerWidth / window.innerHeight, 
        0.1, 
        1000
      );
      app.camera.position.set(0, 1.6, 0);

      // Renderer setup
      app.renderer = new THREE.WebGLRenderer({ 
        antialias: true,
        alpha: false 
      });
      app.renderer.setSize(window.innerWidth, window.innerHeight);
      app.renderer.shadowMap.enabled = true;
      app.renderer.shadowMap.type = THREE.PCFSoftShadowMap;
      app.renderer.xr.enabled = true;
      app.renderer.xr.cameraAutoUpdate = false;

      document.getElementById('container').appendChild(app.renderer.domElement);

      // Lighting setup
      const ambientLight = new THREE.AmbientLight(0x404040, 0.6);
      app.scene.add(ambientLight);

      const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
      directionalLight.position.set(5, 10, 5);
      directionalLight.castShadow = true;
      directionalLight.shadow.mapSize.width = 2048;
      directionalLight.shadow.mapSize.height = 2048;
      app.scene.add(directionalLight);

      // Environment setup
      const gridHelper = new THREE.GridHelper(10, 10, 0x444444, 0x222222);
      gridHelper.position.y = -0.01;
      app.scene.add(gridHelper);

      // Window resize handler
      window.addEventListener('resize', onWindowResize);
    }

    function onWindowResize() {
      app.camera.aspect = window.innerWidth / window.innerHeight;
      app.camera.updateProjectionMatrix();
      app.renderer.setSize(window.innerWidth, window.innerHeight);
    }

    // WebXR initialization
    function initializeWebXR() {
      if ('xr' in navigator) {
        navigator.xr.isSessionSupported('immersive-vr').then((supported) => {
          if (supported) {
            const vrButton = document.getElementById('enterVRBtn');
            vrButton.style.display = 'block';
            vrButton.addEventListener('click', () => {
              app.renderer.xr.getSession() ? 
                app.renderer.xr.getSession().end() : 
                startVRSession();
            });
          } else {
            console.log('VR not supported, but WebXR detected');
          }
        });
      } else {
        console.log('WebXR not available');
      }
    }

    async function startVRSession() {
      try {
        const session = await navigator.xr.requestSession('immersive-vr', {
          optionalFeatures: ['hand-tracking', 'local-floor']
        });
        
        await app.renderer.xr.setSession(session);
        
        session.addEventListener('end', () => {
          console.log('VR session ended');
          updateStatus('VR session ended');
        });
        
        console.log('VR session started');
        updateStatus('VR session active - Security story ready!');
        
      } catch (error) {
        console.error('Failed to start VR session:', error);
        updateStatus('VR session failed to start');
      }
    }

    // Enhanced character loading with better error handling
    async function loadCharacterResources() {
      const characterModels = {
        wendy: './models/wendy.glb',
        mendy: './models/mendy.glb'
      };

      console.log('Loading character resources...');
      
      for (const [name, path] of Object.entries(characterModels)) {
        try {
          // Use the global GLTFLoader from the CDN
          const loader = new THREE.GLTFLoader();
          const gltf = await new Promise((resolve, reject) => {
            loader.load(path, resolve, undefined, reject);
          });
          
          // Set up the character
          const character = gltf.scene;
          character.name = name;
          character.visible = false; // Start hidden
          character.position.set(0, 0, -2); // Default position
          
          // Set up animations if available
          if (gltf.animations && gltf.animations.length > 0) {
            const mixer = new THREE.AnimationMixer(character);
            character.userData.mixer = mixer;
            character.userData.animations = {};
            
            gltf.animations.forEach(clip => {
              const action = mixer.clipAction(clip);
              character.userData.animations[clip.name] = action;
            });
            
            console.log(`✅ Loaded character ${name} with ${gltf.animations.length} animations`);
          } else {
            console.log(`✅ Loaded character ${name} (no animations)`);
          }
          
          app.characters[name] = character;
          app.scene.add(character);
          
        } catch (error) {
          console.warn(`⚠️ Could not load character ${name}:`, error);
          
          // Create placeholder geometry for missing models
          const geometry = new THREE.BoxGeometry(0.5, 1, 0.3);
          const material = new THREE.MeshBasicMaterial({ 
            color: name === 'wendy' ? 0x4CAF50 : 0xFF9800,
            wireframe: true 
          });
          const placeholder = new THREE.Mesh(geometry, material);
          placeholder.name = name + '_placeholder';
          placeholder.visible = false;
          placeholder.position.set(0, 0, -2);
          
          app.characters[name] = placeholder;
          app.scene.add(placeholder);
          console.log(`📦 Created placeholder for ${name}`);
        }
      }
    }

    // Enhanced error handling for missing resources
    async function loadAudioResources() {
      // const audioFiles = {
      //   story: './audio/story.mp3',
      //   reveal: './audio/reveal.mp3',
      //   ambient: './audio/ambient.mp3'
      // };

      console.log('Loading audio resources...');
      
      for (const [name, path] of Object.entries(audioFiles)) {
        try {
          const audio = new Audio(path);
          await new Promise((resolve, reject) => {
            audio.addEventListener('canplaythrough', resolve);
            audio.addEventListener('error', reject);
            audio.load();
          });
          app.audio[name] = audio;
          console.log(`✅ Loaded audio: ${name}`);
        } catch (error) {
          console.warn(`⚠️ Could not load audio ${name}:`, error);
          // Create a mock audio object for fallback
          app.audio[name] = {
            play: () => console.log(`Mock audio playing: ${name}`),
            stop: () => console.log(`Mock audio stopping: ${name}`),
            isPlaying: false
          };
        }
      }
    }

    // Handle gesture events and story progression
    function handleGestureEvents() {
      if (!app.gestureDetector) return;

      // Get current gesture state
      const gestureState = app.gestureDetector.getState();
      const { wave, pinch, point } = gestureState.gestures;

      // Handle wave gesture for story progression
      if (wave.detected && wave.confidence > 0.7) {
        handleWaveGesture();
      }

      // Handle pinch gesture for interactions
      if (pinch.detected && pinch.confidence > 0.8) {
        handlePinchGesture();
      }

      // Handle point gesture for selections
      if (point.detected && point.confidence > 0.7) {
        handlePointGesture(point.direction);
      }

      // Update gesture status display
      updateGestureStatus(gestureState);
    }

    function handleWaveGesture() {
      if (!app.storyController) return;

      const currentState = app.storyController.currentState;
      
      switch (currentState) {
        case 'intro':
          // Start main story when user waves during intro
          if (!app.storyController.isPlaying || app.storyController.actionIndex >= 3) {
            console.log('Wave detected - starting main story');
            app.storyController.start('main');
            updateStatus('Starting security awareness story...');
          }
          break;
          
        case 'end':
          // Restart story when user waves at the end
          console.log('Wave detected - restarting story');
          app.storyController.start('intro');
          updateStatus('Restarting experience...');
          break;
          
        default:
          // Provide feedback during other states
          updateStatus('Wave detected - story in progress...');
      }
    }

    function handlePinchGesture() {
      console.log('Pinch detected - checking for interactions');
      updateStatus('Pinch gesture detected!');
    }

    function handlePointGesture(direction) {
      console.log('Point detected at:', direction);
      updateStatus(`Pointing detected: ${direction.x.toFixed(2)}, ${direction.y.toFixed(2)}, ${direction.z.toFixed(2)}`);
    }

    // Utility functions for story integration
    function updateStatus(message) {
      const statusElement = document.getElementById('status');
      if (statusElement) {
        statusElement.textContent = message;
        console.log('Status:', message);
      }
    }

    function updateGestureStatus(gestureState) {
      const gestureElement = document.getElementById('gestureStatus');
      if (!gestureElement) return;

      const { wave, pinch, point } = gestureState.gestures;
      
      let statusText = 'Gestures: ';
      if (wave.detected) statusText += '👋 Wave ';
      if (pinch.detected) statusText += '🤏 Pinch ';
      if (point.detected) statusText += '👉 Point ';
      if (!wave.detected && !pinch.detected && !point.detected) {
        statusText += 'None detected';
      }

      gestureElement.textContent = statusText;
    }

    // Character management functions
    function showCharacter(characterName) {
      if (app.characters[characterName]) {
        app.characters[characterName].visible = true;
        console.log(`Showing character: ${characterName}`);
        updateStatus(`${characterName} has appeared!`);
      }
    }

    function hideCharacter(characterName) {
      if (app.characters[characterName]) {
        app.characters[characterName].visible = false;
        console.log(`Hiding character: ${characterName}`);
      }
    }

    // Audio management functions
    function playAudio(audioName) {
      if (app.audio[audioName]) {
        // Stop any currently playing audio
        Object.values(app.audio).forEach(sound => {
          if (sound.pause) sound.pause();
        });
        
        // Play the requested audio
        if (app.audio[audioName].play) {
          app.audio[audioName].play();
        }
        console.log(`Playing audio: ${audioName}`);
      } else {
        console.warn(`Audio not found: ${audioName}`);
      }
    }

    function stopAllAudio() {
      Object.values(app.audio).forEach(sound => {
        if (sound.pause) sound.pause();
      });
    }

    // Subtitle management
    window.showSubtitle = function(text) {
      const subtitle = document.getElementById('subtitle');
      if (subtitle) {
        subtitle.textContent = text;
        subtitle.style.display = 'block';
        subtitle.classList.add('fade-in');
      }
    };

    window.hideSubtitle = function() {
      const subtitle = document.getElementById('subtitle');
      if (subtitle) {
        subtitle.style.display = 'none';
        subtitle.classList.remove('fade-in');
      }
    };

    window.setStatus = updateStatus;

    // Animation loop
    function animate() {
      app.renderer.setAnimationLoop(render);
    }

    function render() {
      const deltaTime = app.clock.getDelta();

      // Handle gesture events
      handleGestureEvents();

      // Update story controller
      if (app.storyController && app.storyController.update) {
        app.storyController.update(deltaTime);
      }

      // Update character animations
      Object.values(app.characters).forEach(character => {
        if (character.userData.mixer) {
          character.userData.mixer.update(deltaTime);
        }
      });

      // Update camera for XR
      if (app.renderer.xr.isPresenting) {
        app.renderer.xr.updateCamera(app.camera);
      }

      // Render the scene
      app.renderer.render(app.scene, app.camera);
    }

    // Initialize the application
    async function init() {
      if (app.isInitialized) {
        console.warn('Application already initialized');
        return;
      }

      try {
        console.log('🚀 Initializing Security Awareness XR Application...');
        updateStatus('Initializing XR experience...');
        
        // Create Three.js scene
        createScene();
        updateStatus('Scene created...');
        
        // Load resources
        updateStatus('Loading characters...');
        await loadCharacterResources();
        
        updateStatus('Loading audio...');
        await loadAudioResources();
        
        // Initialize gesture detection (if available)
        if (window.initializeGestures) {
          console.log('Initializing gesture detection...');
          updateStatus('Setting up gesture detection...');
          app.gestureDetector = await window.initializeGestures(app.camera);
        }
        
        // Initialize WebXR
        console.log('Initializing WebXR...');
        updateStatus('Setting up WebXR...');
        initializeWebXR();
        
        // Initialize story controller (if available)
        if (window.setupStory) {
          console.log('Setting up story controller...');
          updateStatus('Preparing security story...');
          app.storyController = window.setupStory(app.characters, app.audio);
          
          // Start intro sequence
          console.log('Starting intro sequence...');
          app.storyController.start('intro');
        }
        
        // Start render loop
        animate();
        
        app.isInitialized = true;
        updateStatus('🎉 Security Awareness XR Experience Ready - Wave to begin!');
        console.log('🎉 Application initialized successfully!');
        
      } catch (error) {
        console.error('❌ Failed to initialize application:', error);
        updateStatus('❌ Failed to initialize - Check console for details');
        
        // Show user-friendly error message
        const errorDiv = document.createElement('div');
        errorDiv.style.cssText = `
          position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
          background: rgba(255,0,0,0.8); color: white; padding: 20px; border-radius: 10px;
          font-family: Arial, sans-serif; text-align: center; z-index: 1000;
        `;
        errorDiv.innerHTML = `
          <h3>⚠️ Initialization Error</h3>
          <p>The XR experience could not be loaded.</p>
          <p>Please check your device compatibility and try again.</p>
          <button onclick="location.reload()" style="padding: 10px 20px; margin-top: 10px;">
            Reload Page
          </button>
        `;
        document.body.appendChild(errorDiv);
      }
    }

    // Reset functionality
    function resetExperience() {
      if (app.storyController && app.storyController.reset) {
        app.storyController.reset();
        app.storyController.start('intro');
        updateStatus('Experience reset - Wave to begin!');
      }
    }

    // Event listeners
    document.getElementById('resetBtn').addEventListener('click', resetExperience);

    // Hide loading indicator when ready
    function hideLoadingIndicator() {
      const loadingIndicator = document.getElementById('loadingIndicator');
      if (loadingIndicator) {
        loadingIndicator.style.display = 'none';
      }
    }

    // Start the application
    document.addEventListener('DOMContentLoaded', () => {
      setTimeout(() => {
        hideLoadingIndicator();
        init();
      }, 1000);
    });

    // Export for debugging
    window.app = app;
    </script>
</body>
</html>